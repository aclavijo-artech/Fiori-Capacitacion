# Versión del esquema MTA utilizada por SAP Cloud MTA Build Tool
_schema-version: "3.2"

# ID único del proyecto MTA. Debe coincidir con el nombre del proyecto en general
ID: projectcamilov2

# Descripción del proyecto. Este campo es informativo
description: Generated by Fiori Tools

# Versión del MTA. Es útil para el control de versiones del descriptor.
version: 0.0.3

# ====================
# DEFINICIÓN DE MÓDULOS
# ====================
modules:

  # Módulo que crea contenido de tipo destination (destinos necesarios para ejecutar la app)
  - name: projectcamilov2-destination-content
    type: com.sap.application.content
    requires:
      # Requiere acceso al servicio de destinos
      - name: projectcamilov2-destination-service
        parameters:
          content-target: true

      # Requiere acceso al servicio de repositorio HTML5 (para almacenar apps)
      - name: projectcamilov2-repo-host
        parameters:
          service-key:
            name: projectcamilov2-repo-host-key

      # Requiere acceso al servicio de autenticación (XSUAA)
      - name: projectcamilov2-uaa
        parameters:
          service-key:
            name: projectcamilov2-uaa-key

    parameters:
      content:
        instance:
          destinations:
            # Destino para acceder al HTML5 App Repo
            - Name: projectcamilov2_html_repo_host
              ServiceInstanceName: projectcamilov2-html5-service
              ServiceKeyName: projectcamilov2-repo-host-key
              sap.cloud.service: projectcamilov2

            # Destino para autenticación vía XSUAA
            - Authentication: OAuth2UserTokenExchange
              Name: projectcamilov2_uaa
              ServiceInstanceName: projectcamilov2-xsuaa-service
              ServiceKeyName: projectcamilov2-uaa-key
              sap.cloud.service: projectcamilov2

          # Política para destinos existentes (update los existentes)
          existing_destinations_policy: update

    # Este módulo no tiene código fuente
    build-parameters:
      no-source: true

  # Módulo para empaquetar la aplicación Fiori en un zip y desplegarla en el HTML5 App Repository
  - name: projectcamilov2-app-content
    type: com.sap.application.content
    path: .  # La raíz del proyecto

    requires:
      # Se conecta al servicio de hosting del repo HTML5
      - name: projectcamilov2-repo-host
        parameters:
          content-target: true

    build-parameters:
      build-result: resources
      requires:
        - artifacts:
            - projectcamilov2.zip  # Archivo que se genera al construir la app
          name: projectcamilov2     # Nombre del módulo fuente
          target-path: resources/   # Carpeta donde se coloca el zip

  # Módulo principal que representa la aplicación Fiori (HTML5)
  - name: projectcamilov2
    type: html5
    path: .  # Ruta raíz del código fuente de la app

    build-parameters:
      build-result: dist  # Carpeta donde se colocan los archivos compilados
      builder: custom     # Se define un proceso de build personalizado
      commands:
        - npm install     # Instala las dependencias de Node.js
        - npm run build:cf  # Ejecuta el script de build definido en package.json
      supported-platforms: []  # Se deja vacío si solo se usa en Cloud Foundry

# ====================
# DEFINICIÓN DE RECURSOS
# ====================
resources:

  # Servicio de destinos (destination)
  - name: projectcamilov2-destination-service
    type: org.cloudfoundry.managed-service
    parameters:
      config:
        HTML5Runtime_enabled: true  # Activa el runtime para apps HTML5
        init_data:
          instance:
            destinations:
              - Authentication: NoAuthentication
                Name: ui5
                ProxyType: Internet
                Type: HTTP
                URL: https://ui5.sap.com  # Destino para cargar la librería SAPUI5
            existing_destinations_policy: update
        version: 1.0.0
      service: destination  # Tipo de servicio en Cloud Foundry
      service-name: projectcamilov2-destination-service  # Nombre único de la instancia
      service-plan: lite  # Plan del servicio (gratuito)

  # Servicio de autenticación (XSUAA)
  - name: projectcamilov2-uaa
    type: org.cloudfoundry.managed-service
    parameters:
      path: ./xs-security.json  # Archivo que define los scopes y roles de seguridad
      service: xsuaa
      service-name: projectcamilov2-xsuaa-service
      service-plan: application

  # Servicio de repositorio de apps HTML5 (host para apps Fiori)
  - name: projectcamilov2-repo-host
    type: org.cloudfoundry.managed-service
    parameters:
      service: html5-apps-repo
      service-name: projectcamilov2-html5-service
      service-plan: app-host

# ====================
# PARÁMETROS GENERALES
# ====================
parameters:
  deploy_mode: html5-repo  # Define que se desplegará en el HTML5 App Repository
  enable-parallel-deployments: true  # Habilita el despliegue paralelo (más rápido en CF)